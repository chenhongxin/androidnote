package cn.xcfamily.community.module.main.fragment;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.androidannotations.annotations.AfterViews;
import org.androidannotations.annotations.Click;
import org.androidannotations.annotations.EFragment;
import org.androidannotations.annotations.ViewById;

import android.app.Activity;
import android.content.Intent;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentPagerAdapter;
import android.text.TextUtils;
import android.view.View;
import android.widget.ImageView;
import android.widget.TextView;
import cn.xcfamily.community.R;
import cn.xcfamily.community.base.BaseActivity;
import cn.xcfamily.community.base.BaseFragment;
import cn.xcfamily.community.constant.ConstantHelperUtil;
import cn.xcfamily.community.constant.MyRequestHandler;
import cn.xcfamily.community.libs.net.RequestTaskManager;
import cn.xcfamily.community.model.responseparam.CircleResponse;
import cn.xcfamily.community.model.responseparam.UserInfo;
import cn.xcfamily.community.module.club.CalendarActivity_;
import cn.xcfamily.community.module.club.IssuePostsActivity_;
import cn.xcfamily.community.widget.DialogBottomChoose;
import cn.xcfamily.community.widget.DialogBottomChoose.ItemClickListener;
import cn.xcfamily.community.widget.InsideViewPager;

import com.alibaba.fastjson.JSON;

@EFragment(R.layout.frag_orange_metting)
public class OrangeClubMeetingFragment2 extends BaseFragment {

	@ViewById(R.id.pager)
	InsideViewPager mViewPager;
	@ViewById(R.id.header)
	View mHeader;
	@ViewById(R.id.mc_head_block)
	TextView mBlockName;
	@ViewById(R.id.mc_share)
	ImageView mc_share;
	private PagerAdapter mPagerAdapter;
	private RequestTaskManager manager;

	public boolean is_start;// 跳转判断，防治双击
	public static String FLAG = "1";

	@AfterViews
	void afterView() {
		manager = new RequestTaskManager();

		CircleResponse circleResponse = new CircleResponse();
		circleResponse.circleName = "全部";
		circleResponses.add(circleResponse);

		setBlock();

		request(CIRCLENAMELIST, true);

	}

	String CIRCLENAMELIST = "circlenamelist";

	void request(String tag, boolean isRun) {
		Map<String, Object> request = new HashMap<String, Object>();
		String url = "";
		if (CIRCLENAMELIST.equals(tag)) {
			url = ConstantHelperUtil.RequestURL.QCIAOBS;
		}
		manager.requestDataByPost(context, url, tag, request, mHandler, isRun,
				isRun);
	}

	List<CircleResponse> circleResponses = new ArrayList<CircleResponse>();
	MyRequestHandler mHandler = new MyRequestHandler() {
		@Override
		public void onSuccess(Object result, String value, String tag) {
			if (CIRCLENAMELIST.equals(tag)) {
				String circle = result.toString();
				circleResponses.addAll(JSON.parseArray(circle,
						CircleResponse.class));
				mPagerAdapter = new PagerAdapter(getActivity()
						.getSupportFragmentManager(), circleResponses);
				mViewPager.setAdapter(mPagerAdapter);
				mViewPager.setOffscreenPageLimit(circleResponses.size());
			}
		}

		@Override
		public void onFailure(Object result, String tag) {
			super.onFailure(result, tag);
		}

	};

	@Override
	public void onResume() {
		super.onResume();
		is_start = false;
	}

	/** 设置小区的信息 */
	public void setBlock() {
		String userinfo = (String) ((BaseActivity) context).util.getData(
				ConstantHelperUtil.UserInfoKey.USER_INFO, null);
		UserInfo user = TextUtils.isEmpty(userinfo) ? null : (JSON.parseObject(
				userinfo, UserInfo.class));
		if (user != null) {
			String city = user.getCityName();
			String mblock = user.getBlockName();
			mBlockName.setText(city + "  " + mblock);
		}
	}

	@Click({ R.id.mc_share })
	void clickView(View v) {
		switch (v.getId()) {
		case R.id.mc_share: {
			if (is_start)
				return;
			is_start = true;
			context.startActivity(new Intent(context, CalendarActivity_.class));
			((Activity) context).overridePendingTransition(
					R.anim.push_right_in, R.anim.push_left_out);
		}
			break;
		}
	}

	List<String> mlist = new ArrayList<String>();

	/** 进入发帖对话框 **/
	@Click(R.id.fragment_carma)
	void getDialog() {
		mlist.clear();
		mlist.add("拍照");
		mlist.add("从手机相册选择");
		mlist.add("仅文字");
		ItemClickListener listener = new ItemClickListener() {

			@Override
			public void onItemClick(int postion) {
				IssuePostsActivity_.intent(context).type(postion).start();
				if (postion == 2) {
					((Activity) context).overridePendingTransition(
							R.anim.push_right_in, R.anim.push_left_out);
				}
			}
		};
		DialogBottomChoose dialog = new DialogBottomChoose(context, listener,
				mlist);
		dialog.showDialog();
	}

	public class PagerAdapter extends FragmentPagerAdapter {

		private List<CircleResponse> circleResponses;

		public PagerAdapter(FragmentManager fm,
				List<CircleResponse> circleResponses) {
			super(fm);
			this.circleResponses = circleResponses;
		}

		@Override
		public int getCount() {
			return circleResponses.size();
		}

		@Override
		public Fragment getItem(int position) {
			ScrollTabHolderFragment fragment = (ScrollTabHolderFragment) SampleListFragment
					.newInstance(circleResponses.get(position), position);

			return fragment;
		}

	}

}
